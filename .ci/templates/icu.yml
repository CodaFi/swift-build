steps:
  - script: |
      git clone --quiet --depth 1 --single-branch --branch $(icu.release) https://github.com/unicode-org/icu.git
      copy $(Build.SourcesDirectory)\cmake\ICU\CMakeLists.txt icu\icu4c
    displayName: 'Fetch Sources'
  - ${{ if eq( variables['Agent.OS'], 'Windows_NT' ) }}:
    - task: BatchScript@1
      inputs:
        filename: C:/Program Files (x86)/Microsoft Visual Studio/2019/Enterprise/Common7/Tools/VsDevCmd.bat
        arguments: -no_logo -arch=$(host) -host_arch=x64
        modifyEnvironment: true
      displayName: 'vcvarsall.bat'
  - task: CMake@1
    inputs:
      workingDirectory: $(Build.StagingDirectory)/icu
      cmakeArgs: $(Build.SourcesDirectory)/icu/icu4c -DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl -G Ninja -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_INSTALL_PREFIX=$(install.directory)/usr -DBUILD_SHARED_LIBS=YES -DBUILD_TOOLS=$(icu.build_tools)
    condition: eq( variables['platform'], 'windows' )
    displayName: 'Configure ICU (windows)'
  - task: CMake@1
    inputs:
      workingDirectory: $(Build.StagingDirectory)/icu
      cmakeArgs: $(Build.SourcesDirectory)/icu/icu4c -G Ninja -C $(Build.SourcesDirectory)/cmake/caches/android-$(arch).cmake -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_INSTALL_PREFIX=$(install.directory)/usr -DBUILD_SHARED_LIBS=YES
    condition: eq( variables['platform'], 'android' )
    displayName: 'Configure ICU (android)'
  - task: CMake@1
    inputs:
      workingDirectory: $(Build.StagingDirectory)/icu
      cmakeArgs: $(Build.SourcesDirectory)/icu/icu4c -G Ninja -C $(Build.SourcesDirectory)/cmake/caches/linux-$(arch).cmake -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_INSTALL_PREFIX=$(install.directory)/usr -DBUILD_SHARED_LIBS=YES
    condition: eq( variables['platform'], 'linux' )
    displayName: 'Configure ICU (linux)'
  - task: CMake@1
    inputs:
      cmakeArgs: --build $(Build.StagingDirectory)/icu
    displayName: 'Build ICU'
  - task: CMake@1
    inputs:
      cmakeArgs: --build $(Build.StagingDirectory)/icu --target install
    displayName: 'Install ICU'
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.StagingDirectory)/Library
      artifactName: icu-$(platform)-$(host)
